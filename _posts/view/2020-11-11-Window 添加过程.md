---
layout: post
title: Window 的添加过程
tags:
  - View
---

# Window 的添加过程
一个窗口创建后，需要主动添加进系统服务 WindowManagerService 中受其统一管理，下面将仔细剖析下窗口的添加过程。
## Window 添加整理流程
窗口添加的整整体程图如下：
![](window_add.png)

其中，整个过程，可大致分为以下五步（分别对应上图中的数字处）：

1、新建一个 RootView，并通过 WindowManger ``addView`` 方法添加为 Window;

2、获取窗口管理系统服务的代理实现类 WindowMangerImpl，其内进一步通过 WindowManagerGloabl 实现窗口视图管理；

3、WindowManagerGloabl 创建根视图管理器 ViewRootImpl，并与 RootView 绑定；

4、WindowManagerGloabl 与系统服务 WindowMangerService 跨进程通信，传递新增窗口参数；

5、WindowMangerService 内检验窗口相关参数，完成窗口在系统服务的添加，并回调结果到 WindowManagerGloabl，流程结束。

下面的部分会通过源码示例的方式，把以上五个步骤具体流程、实现方式深入分析一下，读者可**根据自己想要了解的部分自行跳转阅读**，目录在右侧 👉 可找到。

- 涉及到的源码文件有：
  
```xml
frameworks/base/core/java/android/app
    - Activity.java
    - SystemServiceRegistry.java

frameworks/base/core/java/android/view
    - ViewRootImpl
    - WindowManagerImpl.java
    - WindowManagerGlobal.java

frameworks/base/services/core/java/com/android/server/wm
    - WindowManagerService.java
    - Session.java
```

## 通过 WindowManager 添加 View 为新窗口
```java
class MyActivity extends Activity {
    ...
    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        ...
        WindowManager.LayoutParams layoutParam = new WindowManager.LayoutParams(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LayoutParams.MATCH_PARENT);
        layoutParam.type = WindowManager.LayoutParams.TYPE_APPLICATION_MEDIA;
        View view = new View(this);
        getWindowManager().addView(view, layoutParam);
    }
}
```

```java
public class Activity {
    ...
    final void attach(...) {
        ...
        mWindow = new PhoneWindow(this);
        ...
        mWindow.setWindowManager(
            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),
            mToken, ...);
        ...
        mWindowManager = mWindow.getWindowManager();
    }

    /** Retrieve the window manager for showing custom windows. */
    public WindowManager getWindowManager() {
        return mWindowManager;
    }
    ...
}
```

## 通过 WindowManagerGlobal 进一步管理窗口视图
```java
final class SystemServiceRegistry {
    static {
        ...
        registerService(Context.WINDOW_SERVICE, WindowManager.class,
                new CachedServiceFetcher<WindowManager>() {
            @Override
            public WindowManager createService(ContextImpl ctx) {
                return new WindowManagerImpl(ctx.getDisplay());
            }});
        ...
    }
}
```

```java
public final class WindowManagerImpl implements WindowManager {
    ...
    @Override
    public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) {
        applyDefaultToken(params);
        mGlobal.addView(view, params, mDisplay, mParentWindow);
    }
    ...
}
```

## 创建视图管理器 ViewRootImpl 与 RootView 绑定
```java
public final class WindowManagerGlobal {
    ...
    public void addView(View view, ViewGroup.LayoutParams params,
            Display display, Window parentWindow) {
                final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;
        ...
        if (parentWindow != null) {
            parentWindow.adjustLayoutParamsForSubWindow(wparams);
        } ...

        ViewRootImpl root;
        ...
        synchronized (mLock) {
            ...
            root = new ViewRootImpl(view.getContext(), display);
            view.setLayoutParams(wparams);
            mViews.add(view);
            mRoots.add(root);
            mParams.add(wparams);
        }

        try {
            root.setView(view, wparams, panelParentView);
        } catch (RuntimeException e) {
            // BadTokenException or InvalidDisplayException, clean up.
            synchronized (mLock) {
                final int index = findViewLocked(view, false);
                if (index >= 0) {
                    removeViewLocked(index, true);
                }
            }
            throw e;
        }
    }
}
```

## 传递新增窗口参数至 WindowManagerService
```java
public final class ViewRootImpl implements ViewParent, ... {
    
    final W mWindow;
  
    ...
    public ViewRootImpl(Context context, Display display) {
        ...
        mWindowSession = WindowManagerGlobal.getWindowSession();
        ...
        mWindow = new W(this);
        ...
    }

    ...
    public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {
        ...
        try {
            ...
            res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,
                    getHostVisibility(), mDisplay.getDisplayId(), ...);
        } catch (RemoteException e) {
            ...
            throw new RuntimeException("Adding window failed", e);
        }
        ...
        if (res < WindowManagerGlobal.ADD_OKAY) {
            ...
            throw new WindowManager.BadTokenException("...");
        }
    }
}
```

```java
static class W extends IWindow.Stub {
    private final WeakReference<ViewRootImpl> mViewAncestor;
    private final IWindowSession mWindowSession;

    W(ViewRootImpl viewAncestor) {
        mViewAncestor = new WeakReference<ViewRootImpl>(viewAncestor);
        mWindowSession = viewAncestor.mWindowSession;
    }
    ...
}
```

```java 
public final class WindowManagerGlobal {
    ...
    public static IWindowSession getWindowSession() {
        ...
        if (sWindowSession == null) {
            try {
                ...
                IWindowManager windowManager = getWindowManagerService();
                sWindowSession = windowManager.openSession(...);
            } catch (RemoteException e) {
                Log.e(TAG, "Failed to open window session", e);
            }
        }
        return sWindowSession;
    }
}
```

```java
public class WindowManagerService extends IWindowManager.Stub ... {

    ...
    @Override
    public IWindowSession openSession(IWindowSessionCallback callback, IInputMethodClient client,
            IInputContext inputContext) {
        ···
        Session session = new Session(this, callback, client, inputContext);
        return session;
    }
}
```

```java
final class Session extends IWindowSession.Stub ... {

    ...
    public Session(WindowManagerService service, IWindowSessionCallback callback, ...) {
        mService = service;
        ...
    }

    @Override
    public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs,
            int viewVisibility, int displayId, ...) {
        return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId, ...);
    }
}
```

## WindowManagerService 完成窗口参数检验、添加并回调添加结果
```java
public class WindowManagerService extends IWindowManager.Stub ... {
    ...
    final HashMap<IBinder, WindowState> mWindowMap = new HashMap<>();
    final HashMap<IBinder, WindowToken> mTokenMap = new HashMap<>();

    ...
    public int addWindow(Session session, IWindow client, int seq,
            WindowManager.LayoutParams attrs, int viewVisibility, int displayId, ...) {
        ...
        boolean addToken = false;
        WindowToken token = mTokenMap.get(attrs.token);
        ...
        // 添加窗口合法性检验：
        // 1. 窗口是否被重复添加
        // 2. 子窗口的附着窗口是否存在
        // 3. 应用窗口的 token 检验，系统窗口创建新 token
        // 4. 其他类型窗口检验
        ...
        WindowState win = new WindowState(this, session, client, token,
                    attachedWindow, appOp[0], seq, attrs, viewVisibility, displayContent);
        ...
        res = WindowManagerGlobal.ADD_OKAY;
        if (addToken) {
            mTokenMap.put(attrs.token, token);
        }
        win.attach();
        mWindowMap.put(client.asBinder(), win);
        ...
        return res;
    }
}
```




