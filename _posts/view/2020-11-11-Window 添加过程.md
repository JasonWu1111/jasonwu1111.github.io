---
layout: post
title: Window çš„æ·»åŠ è¿‡ç¨‹
tags:
  - View
---

# Window çš„æ·»åŠ è¿‡ç¨‹
ä¸€ä¸ªçª—å£åˆ›å»ºåï¼Œéœ€è¦ä¸»åŠ¨æ·»åŠ è¿›ç³»ç»ŸæœåŠ¡ WindowManagerService ä¸­å—å…¶ç»Ÿä¸€ç®¡ç†ï¼Œä¸‹é¢å°†ä»”ç»†å‰–æä¸‹çª—å£çš„æ·»åŠ è¿‡ç¨‹ã€‚
## Window æ·»åŠ æ•´ç†æµç¨‹
çª—å£æ·»åŠ çš„æ•´æ•´ä½“ç¨‹å›¾å¦‚ä¸‹ï¼š
![](window_add.png)

å…¶ä¸­ï¼Œæ•´ä¸ªè¿‡ç¨‹ï¼Œå¯å¤§è‡´åˆ†ä¸ºä»¥ä¸‹äº”æ­¥ï¼ˆåˆ†åˆ«å¯¹åº”ä¸Šå›¾ä¸­çš„æ•°å­—å¤„ï¼‰ï¼š

1ã€æ–°å»ºä¸€ä¸ª RootViewï¼Œå¹¶é€šè¿‡ WindowManger ``addView`` æ–¹æ³•æ·»åŠ ä¸º Window;

2ã€è·å–çª—å£ç®¡ç†ç³»ç»ŸæœåŠ¡çš„ä»£ç†å®ç°ç±» WindowMangerImplï¼Œå…¶å†…è¿›ä¸€æ­¥é€šè¿‡ WindowManagerGloabl å®ç°çª—å£è§†å›¾ç®¡ç†ï¼›

3ã€WindowManagerGloabl åˆ›å»ºæ ¹è§†å›¾ç®¡ç†å™¨ ViewRootImplï¼Œå¹¶ä¸ RootView ç»‘å®šï¼›

4ã€WindowManagerGloabl ä¸ç³»ç»ŸæœåŠ¡ WindowMangerService è·¨è¿›ç¨‹é€šä¿¡ï¼Œä¼ é€’æ–°å¢çª—å£å‚æ•°ï¼›

5ã€WindowMangerService å†…æ£€éªŒçª—å£ç›¸å…³å‚æ•°ï¼Œå®Œæˆçª—å£åœ¨ç³»ç»ŸæœåŠ¡çš„æ·»åŠ ï¼Œå¹¶å›è°ƒç»“æœåˆ° WindowManagerGloablï¼Œæµç¨‹ç»“æŸã€‚

ä¸‹é¢çš„éƒ¨åˆ†ä¼šé€šè¿‡æºç ç¤ºä¾‹çš„æ–¹å¼ï¼ŒæŠŠä»¥ä¸Šäº”ä¸ªæ­¥éª¤å…·ä½“æµç¨‹ã€å®ç°æ–¹å¼æ·±å…¥åˆ†æä¸€ä¸‹ï¼Œè¯»è€…å¯**æ ¹æ®è‡ªå·±æƒ³è¦äº†è§£çš„éƒ¨åˆ†è‡ªè¡Œè·³è½¬é˜…è¯»**ï¼Œç›®å½•åœ¨å³ä¾§ ğŸ‘‰ å¯æ‰¾åˆ°ã€‚

- æ¶‰åŠåˆ°çš„æºç æ–‡ä»¶æœ‰ï¼š
  
```xml
frameworks/base/core/java/android/app
    - Activity.java
    - SystemServiceRegistry.java

frameworks/base/core/java/android/view
    - ViewRootImpl
    - WindowManagerImpl.java
    - WindowManagerGlobal.java

frameworks/base/services/core/java/com/android/server/wm
    - WindowManagerService.java
    - Session.java
```

## é€šè¿‡ WindowManager æ·»åŠ  View ä¸ºæ–°çª—å£
```java
class MyActivity extends Activity {
    ...
    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        ...
        WindowManager.LayoutParams layoutParam = new WindowManager.LayoutParams(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LayoutParams.MATCH_PARENT);
        layoutParam.type = WindowManager.LayoutParams.TYPE_APPLICATION_MEDIA;
        View view = new View(this);
        getWindowManager().addView(view, layoutParam);
    }
}
```

```java
public class Activity {
    ...
    final void attach(...) {
        ...
        mWindow = new PhoneWindow(this);
        ...
        mWindow.setWindowManager(
            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),
            mToken, ...);
        ...
        mWindowManager = mWindow.getWindowManager();
    }

    /** Retrieve the window manager for showing custom windows. */
    public WindowManager getWindowManager() {
        return mWindowManager;
    }
    ...
}
```

## é€šè¿‡ WindowManagerGlobal è¿›ä¸€æ­¥ç®¡ç†çª—å£è§†å›¾
```java
final class SystemServiceRegistry {
    static {
        ...
        registerService(Context.WINDOW_SERVICE, WindowManager.class,
                new CachedServiceFetcher<WindowManager>() {
            @Override
            public WindowManager createService(ContextImpl ctx) {
                return new WindowManagerImpl(ctx.getDisplay());
            }});
        ...
    }
}
```

```java
public final class WindowManagerImpl implements WindowManager {
    ...
    @Override
    public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) {
        applyDefaultToken(params);
        mGlobal.addView(view, params, mDisplay, mParentWindow);
    }
    ...
}
```

## åˆ›å»ºè§†å›¾ç®¡ç†å™¨ ViewRootImpl ä¸ RootView ç»‘å®š
```java
public final class WindowManagerGlobal {
    ...
    public void addView(View view, ViewGroup.LayoutParams params,
            Display display, Window parentWindow) {
                final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;
        ...
        if (parentWindow != null) {
            parentWindow.adjustLayoutParamsForSubWindow(wparams);
        } ...

        ViewRootImpl root;
        ...
        synchronized (mLock) {
            ...
            root = new ViewRootImpl(view.getContext(), display);
            view.setLayoutParams(wparams);
            mViews.add(view);
            mRoots.add(root);
            mParams.add(wparams);
        }

        try {
            root.setView(view, wparams, panelParentView);
        } catch (RuntimeException e) {
            // BadTokenException or InvalidDisplayException, clean up.
            synchronized (mLock) {
                final int index = findViewLocked(view, false);
                if (index >= 0) {
                    removeViewLocked(index, true);
                }
            }
            throw e;
        }
    }
}
```

## ä¼ é€’æ–°å¢çª—å£å‚æ•°è‡³ WindowManagerService
```java
public final class ViewRootImpl implements ViewParent, ... {
    
    final W mWindow;
  
    ...
    public ViewRootImpl(Context context, Display display) {
        ...
        mWindowSession = WindowManagerGlobal.getWindowSession();
        ...
        mWindow = new W(this);
        ...
    }

    ...
    public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {
        ...
        try {
            ...
            res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,
                    getHostVisibility(), mDisplay.getDisplayId(), ...);
        } catch (RemoteException e) {
            ...
            throw new RuntimeException("Adding window failed", e);
        }
        ...
        if (res < WindowManagerGlobal.ADD_OKAY) {
            ...
            throw new WindowManager.BadTokenException("...");
        }
    }
}
```

```java
static class W extends IWindow.Stub {
    private final WeakReference<ViewRootImpl> mViewAncestor;
    private final IWindowSession mWindowSession;

    W(ViewRootImpl viewAncestor) {
        mViewAncestor = new WeakReference<ViewRootImpl>(viewAncestor);
        mWindowSession = viewAncestor.mWindowSession;
    }
    ...
}
```

```java 
public final class WindowManagerGlobal {
    ...
    public static IWindowSession getWindowSession() {
        ...
        if (sWindowSession == null) {
            try {
                ...
                IWindowManager windowManager = getWindowManagerService();
                sWindowSession = windowManager.openSession(...);
            } catch (RemoteException e) {
                Log.e(TAG, "Failed to open window session", e);
            }
        }
        return sWindowSession;
    }
}
```

```java
public class WindowManagerService extends IWindowManager.Stub ... {

    ...
    @Override
    public IWindowSession openSession(IWindowSessionCallback callback, IInputMethodClient client,
            IInputContext inputContext) {
        Â·Â·Â·
        Session session = new Session(this, callback, client, inputContext);
        return session;
    }
}
```

```java
final class Session extends IWindowSession.Stub ... {

    ...
    public Session(WindowManagerService service, IWindowSessionCallback callback, ...) {
        mService = service;
        ...
    }

    @Override
    public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs,
            int viewVisibility, int displayId, ...) {
        return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId, ...);
    }
}
```

## WindowManagerService å®Œæˆçª—å£å‚æ•°æ£€éªŒã€æ·»åŠ å¹¶å›è°ƒæ·»åŠ ç»“æœ
```java
public class WindowManagerService extends IWindowManager.Stub ... {
    ...
    final HashMap<IBinder, WindowState> mWindowMap = new HashMap<>();
    final HashMap<IBinder, WindowToken> mTokenMap = new HashMap<>();

    ...
    public int addWindow(Session session, IWindow client, int seq,
            WindowManager.LayoutParams attrs, int viewVisibility, int displayId, ...) {
        ...
        boolean addToken = false;
        WindowToken token = mTokenMap.get(attrs.token);
        ...
        // æ·»åŠ çª—å£åˆæ³•æ€§æ£€éªŒï¼š
        // 1. çª—å£æ˜¯å¦è¢«é‡å¤æ·»åŠ 
        // 2. å­çª—å£çš„é™„ç€çª—å£æ˜¯å¦å­˜åœ¨
        // 3. åº”ç”¨çª—å£çš„ token æ£€éªŒï¼Œç³»ç»Ÿçª—å£åˆ›å»ºæ–° token
        // 4. å…¶ä»–ç±»å‹çª—å£æ£€éªŒ
        ...
        WindowState win = new WindowState(this, session, client, token,
                    attachedWindow, appOp[0], seq, attrs, viewVisibility, displayContent);
        ...
        res = WindowManagerGlobal.ADD_OKAY;
        if (addToken) {
            mTokenMap.put(attrs.token, token);
        }
        win.attach();
        mWindowMap.put(client.asBinder(), win);
        ...
        return res;
    }
}
```




