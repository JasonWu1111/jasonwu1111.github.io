---
layout: post
title: Activity 的启动过程分析
tags:
  - Android
  - Activity
---

# Activity 的启动过程分析
**Activity** 为开发者最常接触和使用的系统基础组件，这注定了 Activity 启动的流程整体较为复杂，每个 Android 系统版本都会对 Activity 的启动过程做一定的优化和重构，但核心的流程思路是一致。本文继续以 **Android 11** 的代码为基础，详解 Activity 的启动流程。

## ActivityTaskManager 发起 startActivity 请求
在 Android 10 以前，包含 Activity 在内的四大组件的启动与管理，都是通过系统服务 **ActivityManagerService** 来负责。而从 Android 10 开始，Activity 的这部分抽离了出来，改到了在新的 **ActivityTaskManagerService** 中来处理。

与其他常用的系统服务一样，应用进程内也有相应的 **ActivityTaskManager** 和 ActivityTaskManagerService 对应，两者间通过 `Binder` 完成 IPC 通信。

启动一个新的 Activity 从 `startActivity()` 方法开始，逐步调用到 ActivityTaskManager 发起通信：

![](/img/posts/post-activity-start.png)

<!-- Title: Activity 的启动过程（一）
participant Activity
participant Instrumentation
participant ActivityTaskManager
participant ActivityTaskManagerService

Activity->Activity: startActivity(intent)
Activity->Instrumentation: startActivityForResult()
Instrumentation->ActivityTaskManager: execStartActivity()
ActivityTaskManager-\->ActivityTaskManagerService: startActivity()
ActivityTaskManagerService->ActivityTaskManagerService: startActivity()\n...
ActivityTaskManagerService-\->Instrumentation: result -->

```white
frameworks/base/core/java/android/app/
    - Activity.java
    - Instrumentation.java
    - IActivityTaskManager.aidl
    - ActivityTaskManager.java

frameworks/base/services/core/java/com/android/server/wm/    
    - ActivityTaskManagerService.java
```

其中实现的 `Binder` 通信对应的 aidl 文件为 **IActivityTaskManager.aidl**：
```java
interface IActivityTaskManager {
    int startActivity(in IApplicationThread caller, ..., in Intent intent, ...);
    ...
}
```

**ActivityTaskManager** 内持有一个单例实现为 IActivityTaskManager 接口的 client 端实现，代码示例如下：
```java
@SystemService(Context.ACTIVITY_TASK_SERVICE)
public class ActivityTaskManager {
    ...
    private static final Singleton<IActivityTaskManager> IActivityTaskManagerSingleton =
            new Singleton<IActivityTaskManager>() {
                @Override
                protected IActivityTaskManager create() {
                    final IBinder b = ServiceManager.getService(Context.ACTIVITY_TASK_SERVICE);
                    return IActivityTaskManager.Stub.asInterface(b);
                }
            };
    ...
}
```

而 **ActivityTaskManagerService** 运行在系统服务 `system_server` 进程，作为 IActivityTaskManager 接口的 server 端。

## ActivityStarter 启动逻辑处理

其后在 ActivityTaskManagerService 中进一步通过 **ActivityStarter** 来处理目标 Activity 的启动逻辑，流程如下：

![](/img/posts/post-activity-start2.png)

```white
frameworks/base/services/core/java/com/android/server/wm/
    - ActivityStarter.java
    - ActivityRecord.java
```

<!-- Title: Activity 的启动过程（二）
ActivityTaskManagerService->ActivityTaskManagerService: startActivity()
ActivityTaskManagerService->ActivityStarter: startActivityAsUser()
ActivityStarter->ActivityStarter: execute()
ActivityStarter->ActivityStarter: executeRequest()
ActivityStarter->ActivityStarter: startActivityUnchecked(ActivityRecord r)
ActivityStarter->ActivityStarter: startActivityInner(r)
ActivityStarter->ActivityStarter: ... -->

在 ActivityStarter 中会创建一个用于**在系统服务中描述当前 Activity 的 `ActivityRecord` 对象**，其包含了如 token、Activity 的状态、intent 等各类信息，是系统服务层面用于记录 Activity 相关的各种操作后的**核心对象**。部分字段属性示例如下：

```java
 
```

在 **ActivityStarter** 的 `startActivityInner()` 方法中，完成了几项 Activity 启动流程中关键的



# Activity 的启动
participant Context
participant Instrumentation
participant ActivityTaskManager
participant ActivityTaskManagerService
participant ActivityStarter
participant RootWindowContainer
participant ActivityStack
participant ActivityStackSupervisor
participant ClientLifecycleManager
participant ClientTransaction

Title: Activity 的启动过程（三）
ActivityStarter->RootWindowContainer: startActivityInner(r)
RootWindowContainer->ActivityStack: resumeFocusedStacksTopActivities()
ActivityStack->ActivityStack: resumeTopActivityUncheckedLocked()
ActivityStack->ActivityStackSupervisor: resumeTopActivityInnerLocked()
ActivityStackSupervisor->ActivityStackSupervisor: startSpecificActivity()
ActivityStackSupervisor->ClientLifecycleManager: realStartActivityLocked()

Title: Activity 的启动过程（四）
ActivityStackSupervisor->ClientLifecycleManager: realStartActivityLocked()
ClientLifecycleManager->ClientTransaction: scheduleTransaction()
ClientTransaction->IApplicationThread$Proxy: schedule()
IApplicationThread$Proxy-->ActivityThread$ApplicationThread: scheduleTransaction()

Title: Activity 的启动过程（五）
ActivityThread$ApplicationThread->ActivityThread: scheduleTransaction()
ActivityThread->ActivityThread: scheduleTransaction()
ActivityThread->ActivityThread$H: sendMessage()
ActivityThread$H->TransactionExecutor: handleMessage()
TransactionExecutor->TransactionExecutor: execute()
TransactionExecutor->LaunchActivityItem: executeCallbacks()
LaunchActivityItem->ActivityThread: execute()
ActivityThread->ActivityThread: handleLaunchActivity()
ActivityThread->Instrumentation: performLaunchActivity()
Instrumentation->Activity: callActivityOnCreate()
Activity->Activity: performCreate()
Activity->Activity: onCreate()

Title: Activity 的启动过程（六）
ActivityStarter->ActivityStarter: startActivityInner()
ActivityStarter->ActivityStarter: deliverToCurrentTopIfNeeded(ActivityStack topStack)
ActivityStarter->ActivityRecord: deliverNewIntent(ActivityRecord top)
ActivityRecord->ClientLifecycleManager: deliverNewIntentLocked(intent)
ClientLifecycleManager->ClientTransaction: scheduleTransaction()
